<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>core.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>core.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">LOGGER</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span> <span class="k">as</span> <span class="n">peak_find</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">spsolve</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">least_squares</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">import</span> <span class="nn">utilities</span> <span class="kn">as</span> <span class="nn">utili</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>TODO: need to fail if peak fitting doesn&rsquo;t work!
fix peak finder
add argument for number of peaks to use pick these based on some paramter e.g. prominence
sort peaks in this order
add try for matplotlib and set interactive background to not run if it fails</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>thunder object with all the methods we love inside it. Name generated using WuTang Clan name generator.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Thunder</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Thunder</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>  <span class="c1"># this is what we will create later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span> <span class="c1"># later we will fill this with background remove data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_ind</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_ind</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;x_axis&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;y_axis&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;data.txt&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">ModelResult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span> <span class="n">plt</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_data</span><span class="p">:</span> <span class="p">{}</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;yfit&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;peak_types&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;peak_centres&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;peak_widths&#39;</span><span class="p">:[],</span>
                                <span class="s1">&#39;peak_amps&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;chisq&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;free_params&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;p_value&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;tightness&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
                                <span class="s1">&#39;bounds&#39;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;centers&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;widths&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;amps&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">}}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">Thunder</span><span class="p">):</span>  <span class="c1"># if only pass one but its already a thunder object then just use that</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_thunder</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># add all the details in depending on args</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_thunder</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>  <span class="c1"># add all the details in depending on args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot convert input to Thunder object&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_ind</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">e_label</span><span class="p">)</span> <span class="c1"># load the data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness_setter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;tightness&#39;</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <h3>loading data and thunder object</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">overwrite_thunder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
        <span class="n">thun</span> <span class="o">=</span> <span class="n">inp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_ind</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">x_ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">y_ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_ind</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">e_ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">x_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">y_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">datapath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="n">thun</span><span class="o">.</span><span class="n">user_params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>Used to create a thunder object given different input types
:param args: a,b,c depending on type of input and
:return: None, we modify the object unless a spec1d object is passed, in which case we return that</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">create_thunder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x_label&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">)</span>  <span class="c1"># if the key exists then set as that, otherwise make it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y_label&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_label</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;e_label&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_label</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_ind</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;x_ind&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y_ind</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;y_ind&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_ind</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;e_ind&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;KeyError: Missing field in the data dictionary: {e}&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fit_params&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>load in data as a pandas df - save by modifying self.data, use object params to load
:return: None</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">x_ind</span><span class="p">,</span> <span class="n">y_ind</span><span class="p">,</span> <span class="n">x_label</span><span class="p">,</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">e_ind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">e_label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="s1">&#39;.h5&#39;</span> <span class="ow">in</span> <span class="n">datapath</span><span class="p">:</span> <span class="c1"># if the data is already stored as a pandas df</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Too many keys in the hdfstore, will assume all should be concated&quot;</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;not sure this concat works yet&quot;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span> <span class="c1"># not sure this will work! concat all keys dfs together</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># if only one key then we use it as the datafile</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># its a txt or csv file</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># load in, works for .txt and .csv</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>this needs to be made more flexible/user defined</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">col_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_ind</span><span class="p">,</span> <span class="n">y_ind</span><span class="p">]</span>
        <span class="n">col_lab</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_label</span><span class="p">,</span> <span class="n">y_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">e_ind</span><span class="p">:</span> <span class="c1"># if we have specified this column then we use it, otherwise just x and y</span>
            <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;You have specified an e_ind but there are less than 3 columns in the data&quot;</span>
            <span class="n">col_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_ind</span><span class="p">)</span>
            <span class="n">col_lab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_label</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col_ind</span><span class="p">]</span>  <span class="c1"># keep only these columns, don&#39;t want to waste memory</span>
        <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_lab</span>   <span class="c1"># rename the columns</span>
        <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="c1"># drop any rows with NaN etc in them</span>
        <span class="k">return</span> <span class="n">data</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tightness_setter</span><span class="p">(</span><span class="n">tightness</span><span class="p">):</span>
        <span class="n">tight_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">tightness</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tightness</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tightness</span> <span class="o">==</span> <span class="s1">&#39;med&#39;</span><span class="p">:</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">tightness</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;The tightness defined was incorrect format, use low, med or high. Using default med settings&#39;</span><span class="p">)</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">tight_dict</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tight_dict</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <h3>end loading</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <h3>background</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">background_finder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_label</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span>
        <span class="n">data_bg_rm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span>

        <span class="k">if</span> <span class="n">bg</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>  <span class="c1"># then user doesn&#39;t want to make a background</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Warning: no background specified, so not using a background,&quot;</span>
                <span class="s2">&quot; this may prevent algorithm from converging&quot;</span><span class="p">)</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">y_data</span><span class="p">])</span>  <span class="c1"># set the background as 0 everywhere</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_data</span> <span class="c1"># no background subtracted</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span>

        <span class="k">elif</span> <span class="n">bg</span> <span class="o">==</span> <span class="s1">&#39;SCARF&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">y_data</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">window_length</span><span class="p">,</span> <span class="n">poly_order</span> <span class="o">=</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">3</span>
            <span class="n">L_sg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_data</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">utili</span><span class="o">.</span><span class="n">rcf</span><span class="p">(</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">],</span> <span class="n">rad</span><span class="p">)</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">])</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;SCARF background removal requires user input. Please look at the following bg with rad={rad}&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;If you are happy with the plot, type y. if not then please type a new rad&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span>

                <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">b</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span> <span class="c1"># now estimate a baseline to add to D to get L</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">])</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please look at the following bg with a shift={b}&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;If you are happy with the plot, type y. if not then please type a new background value. </span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;Please note that the background should NOT intercept the data. Ideally it would pass through&quot;</span>
                                <span class="s2">&quot;the mean of the noise for the correct bg already fit&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">b</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
                            <span class="n">L</span> <span class="o">=</span> <span class="n">D</span> <span class="o">+</span> <span class="n">b</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>then apply SG filter to L</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">L_sg</span> <span class="o">=</span> <span class="n">utili</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">)</span>
                        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">L_sg</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">])</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please look at the following bg with Sg filter parameters (window length, polynomial order): &quot;</span>
                              <span class="n">f</span><span class="s2">&quot;{window_length}, {poly_order}&quot;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span>
                            <span class="s2">&quot;Incorrect values for window_length and poly_order have been entered. Poly order must be less than window length and window length must be odd&quot;</span><span class="p">)</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;please enter y if you are happy with these values, or enter two integers with a space &quot;</span>
                                    <span class="s2">&quot;for window_length and poly_order&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">L</span> <span class="o">=</span> <span class="n">L_sg</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The tuple was more than two elements long&quot;</span><span class="p">)</span>
                            <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">poly_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>final question before exiting</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please look at the following bg with selected parameters&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Are you happy with this bg? If yes, type y, else type n. n will restart the fitting. </span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;typing repeat will add an additional bg subtraction to this one&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">bg</span> <span class="o">+=</span> <span class="n">L</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span><span class="s1">&#39;repeat&#39;</span><span class="p">:</span>
                    <span class="n">bg</span> <span class="o">+=</span> <span class="n">L</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;apply two bg removal steps, this will mean the background just specified will be removed &quot;</span>
                          <span class="s2">&quot;from the data&quot;</span><span class="p">)</span>
                    <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">-=</span> <span class="n">L</span> <span class="c1"># remove the bg found here from the original data and go again</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying whole fitting routine again...&quot;</span><span class="p">)</span>

            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">-=</span> <span class="n">L</span>  <span class="c1"># subtract background from the data</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_data</span><span class="p">),</span> \
                    <span class="s2">&quot;the background generated or passed is of incorrect length&quot;</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">bg</span> <span class="c1"># subtract user supplied background from the data</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span>

        <span class="k">elif</span> <span class="n">bg</span> <span class="o">==</span> <span class="s1">&#39;OLD&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_background</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span> <span class="c1"># find a background the old way</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">bg</span>  <span class="c1"># subtract background from the data</span>
            <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">x_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># then it is the incorrect type</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;the background passed is in the incorrect format, please pass as type np array&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>y_min = data_bg_rm[y_label].min()
if y_min &lt; 0:
   data_bg_rm[y_label] += abs(y_min)  # then shift all the data up so no points are below zero
   bg -= abs(y_min)  # and lower the bg we have calculated by that shift too</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span> <span class="o">=</span> <span class="n">data_bg_rm</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>old</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">find_background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span><span class="p">])]</span>
        <span class="n">baseline_values</span> <span class="o">=</span> <span class="n">least_squares</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residual_baseline</span><span class="p">,</span> <span class="n">params</span><span class="p">[:],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,),</span>
                                  <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

        <span class="n">p</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">baseline_values</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="n">baseline_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_als</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">baseline_values</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>old</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">residual_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">niter</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseline_als</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">niter</span><span class="p">)</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">baseline</span>
        <span class="k">return</span> <span class="n">residual</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>old</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">baseline_als</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">L</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">L</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">niter</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n iter is too small!&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">):</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">spdiags</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">W</span> <span class="o">+</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">D</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">spsolve</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <h4>background end</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <h3>normalise</h3>
<p>normalise using std variance normalisation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">normalisation</span><span class="p">(</span><span class="n">y_data</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">mean_y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span>
        <span class="n">shifted_y_data</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">mean_y_data</span>
        <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span>
        <span class="n">normalised_y</span> <span class="o">=</span> <span class="n">shifted_y_data</span> <span class="o">/</span> <span class="n">std_dev</span>
        <span class="k">return</span> <span class="n">normalised_y</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <h3>normalise end</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <h4>peak finding</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">peaks_unspecified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specified_dict</span><span class="p">):</span>
        <span class="n">x_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>fix this up since only cents_specified works now</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">specified_dict</span><span class="p">[</span><span class="s1">&#39;cents_specified&#39;</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>width_ranges = [50, len(x_data) / 2]  # these are index widths TODO make this a variable&hellip;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">prominence</span> <span class="o">=</span> <span class="mf">1.6</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>do question asking routine for picking prominence to find peaks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">peak_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_finder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">],</span>
                                                    <span class="n">prominence</span><span class="p">)</span>  <span class="c1"># find the peak centers</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>use peak info dict and store the heights and widths of peaks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span><span class="p">[</span><span class="n">peak_info</span><span class="p">[</span><span class="s1">&#39;center_indices&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># these are the indices of the centres</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_data</span><span class="p">[</span><span class="n">peak_info</span><span class="p">[</span><span class="s1">&#39;right_edges&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">x_data</span><span class="p">[</span><span class="n">peak_info</span><span class="p">[</span><span class="s1">&#39;left_edges&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_info</span><span class="p">[</span><span class="s1">&#39;amps&#39;</span><span class="p">]</span>
            <span class="kn">import</span> <span class="nn">ipdb</span>
            <span class="n">ipdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>set bounds from these too</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">specified_dict</span><span class="p">[</span><span class="s1">&#39;amps_specified&#39;</span><span class="p">]:</span> <span class="c1"># find a faster way to do this</span>
            <span class="n">xcents</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">]</span> <span class="c1"># this is x data</span>
            <span class="n">peak_centres_indices</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">]</span> <span class="o">-</span> <span class="n">xval</span><span class="p">)</span>
                                 <span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">xval</span> <span class="ow">in</span> <span class="n">xcents</span><span class="p">]</span> <span class="c1">#find the indices for these xvalues</span>
            <span class="n">peak_centres_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">peak_centres_indices</span><span class="p">]</span> <span class="c1"># stupid pandas index type</span>

            <span class="n">y_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">][</span><span class="n">peak_centres_indices</span><span class="p">]</span>  <span class="c1"># get the y values from the indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y_peaks</span><span class="p">)</span>  <span class="c1"># all peak amps are the order of mag of largest y</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">specified_dict</span><span class="p">[</span><span class="s1">&#39;widths_specified&#39;</span><span class="p">]:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">x_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x_data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">specified_dict</span><span class="p">[</span><span class="s1">&#39;types_specified&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;LorentzianModel&#39;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">]]</span>  <span class="c1"># we assume all the types are gaussian</span>


        <span class="n">len_ord_specified</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">specified_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># get the shortest</span>
        <span class="n">len_ord_specified</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">tup</span><span class="p">:</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len_ord_specified</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shortest_specified</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">len_ord_specified</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># this is the dict key with the shortest specified data</span>

            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_centres&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_widths&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_types&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="n">param</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">specified_dict</span><span class="p">[</span><span class="n">shortest_specified</span><span class="p">]:</span> <span class="c1"># then we need to trim it</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Some of the specified peak parameters differ in length. Choosing peak paramters&quot;</span>
                                   <span class="s2">&quot;as the first n parameters where n is the length of the shortest set of parameters&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="n">param</span><span class="p">][:</span><span class="n">specified_dict</span><span class="p">[</span><span class="n">shortest_specified</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">pass</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">peak_finder</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">prominence</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>do a routine looping through until the right number of peaks is found</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">peaks</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">peak_find</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence</span><span class="p">)</span> <span class="c1"># find the peak positions in the data</span>

        <span class="n">peaks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="c1"># convert to a list</span>
        <span class="n">amps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;prominences&#39;</span><span class="p">])</span> <span class="c1"># store the heights</span>

        <span class="n">peak_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;center_indices&#39;</span><span class="p">:</span><span class="n">peaks</span><span class="p">,</span> <span class="s1">&#39;right_edges&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;right_bases&#39;</span><span class="p">]),</span>
                     <span class="s1">&#39;left_edges&#39;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="p">[</span><span class="s1">&#39;left_bases&#39;</span><span class="p">]),</span> <span class="s1">&#39;amps&#39;</span><span class="p">:</span><span class="n">amps</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">peak_info</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <h4>peak finding end</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <h4>peak fitting</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">fit_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_bounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_specs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;y_bg_rm&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">specs</span><span class="p">[</span><span class="s1">&#39;x_bg_rm&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The fitting routine failed! exiting programme. Try lowering tightness settings or manually &#39;</span>
                         <span class="s1">&#39;inputting a background, peak bounds and peak info.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">best_values</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">make_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_bg_rm</span><span class="p">,</span> <span class="n">user_params</span><span class="p">,</span> <span class="n">y_label</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">l_cent_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">cent</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">*</span>
                             <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">])]</span>
            <span class="n">u_cent_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">cent</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span><span class="p">[</span><span class="s1">&#39;centre_bounds&#39;</span><span class="p">]</span> <span class="o">*</span>
                             <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cent</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">])]</span>
            <span class="n">cent_bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_cent_bounds</span><span class="p">,</span> <span class="n">u_cent_bounds</span><span class="p">))</span>
            <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cent_bounds</span>

        <span class="k">if</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;widths&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">peak_widths</span> <span class="o">=</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">]</span>
            <span class="n">l_width_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">peak_widths</span><span class="p">]</span>
            <span class="n">u_width_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tightness</span><span class="p">[</span><span class="s1">&#39;width_bounds&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">width</span> <span class="ow">in</span> <span class="n">peak_widths</span><span class="p">]</span>
            <span class="n">width_bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_width_bounds</span><span class="p">,</span> <span class="n">u_width_bounds</span><span class="p">))</span>
            <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;widths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width_bounds</span>

        <span class="k">if</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amps&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">peak_amps</span> <span class="o">=</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">]</span>
            <span class="n">amps_lb</span> <span class="o">=</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># maybe change this to min</span>
            <span class="n">amps_ub</span> <span class="o">=</span> <span class="n">data_bg_rm</span><span class="p">[</span><span class="n">y_label</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">l_amp_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">amps_lb</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">peak_amps</span><span class="p">]</span>
            <span class="n">u_amp_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">amps_ub</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">peak_amps</span><span class="p">]</span>
            <span class="n">amp_bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">l_amp_bounds</span><span class="p">,</span> <span class="n">u_amp_bounds</span><span class="p">))</span>
            <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_bounds</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>todo currently our bounds are set by the data ranges. It may make sense to define
narrower ranges around the peaks themselves</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">user_params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>https://chrisostrouchov.com/post/peak_fit_xrd_python/
:param spec:
:return:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">build_specs</span><span class="p">(</span><span class="n">x_bg_rm</span><span class="p">,</span> <span class="n">y_bg_rm</span><span class="p">,</span> <span class="n">user_params</span><span class="p">):</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_bg_rm&#39;</span><span class="p">:</span><span class="n">x_bg_rm</span><span class="p">,</span> <span class="s1">&#39;y_bg_rm&#39;</span><span class="p">:</span><span class="n">y_bg_rm</span><span class="p">,</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                               <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]},</span>
                     <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;centers&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;centers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;amps&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amps&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                <span class="s1">&#39;widths&#39;</span><span class="p">:</span> <span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;widths&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]}</span>
                    <span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">])]</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">specs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_model</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">composite_model</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">basis_func</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;m{i}_&#39;</span>
            <span class="n">model</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;GaussianModel&#39;</span><span class="p">,</span> <span class="s1">&#39;LorentzianModel&#39;</span><span class="p">,</span><span class="s1">&#39;VoigtModel&#39;</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>for now VoigtModel has gamma constrained to sigma</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">w_min</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;widths&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">w_max</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;widths&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">x_min</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;centers&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;centers&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">y_min</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amps&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">y_max</span> <span class="o">=</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amps&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">w_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">w_max</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">x_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">x_max</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">y_max</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">set_param_hint</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>default guess is horrible!! do not use guess()</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;center&#39;</span><span class="p">],</span>
                    <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;amp&#39;</span><span class="p">],</span>
                    <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">basis_func</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;model {basis_func[&quot;type&quot;]} not implemented yet&#39;</span><span class="p">)</span>

            <span class="n">model_params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="o">**</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="n">basis_func</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">{}))</span>

            <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># first loop</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">model_params</span>
                <span class="n">composite_model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># subsequent loops</span>
                <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_params</span><span class="p">)</span>
                <span class="n">composite_model</span> <span class="o">=</span> <span class="n">composite_model</span> <span class="o">+</span> <span class="n">model</span>

        <span class="k">return</span> <span class="n">composite_model</span><span class="p">,</span> <span class="n">params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <h4>peak fitting end</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <h4>plotting</h4>
<p>todo fix the assertions in these</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">linethickness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>assert isinstance(ax, axes._subplots.AxesSubplot), &ldquo;the figure passed isn&rsquo;t the correct format, please pass&rdquo; \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                                                 <span class="s2">&quot; an axes object&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linethickness</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_fits</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">linethickness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>assert isinstance(ax, axes._subplots.AxesSubplot), &ldquo;the figure passed isn&rsquo;t the correct format, please pass&rdquo; \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                                                <span class="s2">&quot; an axes object&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">peak</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">peaks</span><span class="p">[</span><span class="n">peak</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linethickness</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_background</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">background_data</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;b--&#39;</span><span class="p">,</span> <span class="n">linethickness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>assert isinstance(ax, axes._subplots.AxesSubplot), &ldquo;the figure passed isn&rsquo;t the correct format, please pass&rdquo; \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                                                 <span class="s2">&quot; an axes object&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">background_data</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linethickness</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_fit_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">peak_sum</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linethickness</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span> <span class="c1"># option of including background</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>assert isinstance(ax, axes._subplots.AxesSubplot), &ldquo;the figure passed isn&rsquo;t the correct format, please pass&rdquo; \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                                                 <span class="s2">&quot; an axes object&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="nb">sum</span> <span class="o">=</span> <span class="n">peak_sum</span> <span class="o">+</span> <span class="n">background</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linethickness</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_uncertainty_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">eval_unc</span><span class="p">,</span> <span class="n">peak_sum</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#ABABAB&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>assert isinstance(ax, axes._subplots.AxesSubplot), &ldquo;the figure passed isn&rsquo;t the correct format, please pass&rdquo; \</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                                                 <span class="s2">&quot; an axes object&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">peak_sum</span> <span class="o">-</span> <span class="n">eval_unc</span><span class="p">,</span> <span class="n">peak_sum</span> <span class="o">+</span> <span class="n">eval_unc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span> <span class="c1">#plot a grey band of uncertainty</span>

        <span class="k">return</span> <span class="n">ax</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">plot_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_fits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">eval_components</span><span class="p">())</span> <span class="c1"># plot each component of the model</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_background</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="p">)</span> <span class="c1">#plot the background supplied by user</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_fit_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="p">)</span> <span class="c1"># plot the fitted data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_uncertainty_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">eval_uncertainty</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="c1">#plot a band of uncertainty</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;There are not uncertainties available for some reason - &#39;</span>
                         <span class="s1">&#39;try lowering the tightness of automatic bounds&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_label</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_label</span><span class="p">],</span> <span class="n">ax</span><span class="p">)</span>  <span class="c1"># plot the raw data</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">plt</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <h4>plotting end</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">fit_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">mod_no</span><span class="p">:{}</span> <span class="k">for</span> <span class="n">mod_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">]))}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <h1>total fit data</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">chi_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">chisqr</span>
        <span class="n">reduced_chi_sq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">redchi</span>
        <span class="n">free_params</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">chi_sq</span> <span class="o">/</span> <span class="n">reduced_chi_sq</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <h1>individual parameter data</h1>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">param_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;center&quot;</span><span class="p">:</span><span class="s2">&quot;centers&quot;</span><span class="p">,</span> <span class="s2">&quot;amplitude&quot;</span><span class="p">:</span><span class="s2">&quot;amps&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">:</span><span class="s2">&quot;widths&quot;</span><span class="p">,</span> <span class="s2">&quot;fwhm&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">param_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_no</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">parameter</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">param_type</span> <span class="o">=</span> <span class="n">param_info</span><span class="p">[</span><span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">param_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">param_type</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span><span class="n">param_obj</span><span class="o">.</span><span class="n">value</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">param_obj</span><span class="o">.</span><span class="n">stderr</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">][</span><span class="n">model_no</span><span class="p">]</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_params</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="n">param_type</span><span class="p">][</span><span class="n">model_no</span><span class="p">]</span>

                <span class="n">fit_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">value</span><span class="p">,</span>
                            <span class="s2">&quot;stderr&quot;</span><span class="p">:</span><span class="n">err</span><span class="p">,</span>
                            <span class="s2">&quot;peak_type&quot;</span><span class="p">:</span><span class="nb">type</span><span class="p">,</span>
                            <span class="s2">&quot;bounds&quot;</span><span class="p">:</span><span class="n">bounds</span><span class="p">}</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fit_data</span><span class="p">[</span><span class="n">model_no</span><span class="p">][</span><span class="n">param_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_info</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">peak_details</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="n">cents_specified</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">])</span>
    <span class="n">types_specified</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">])</span>
    <span class="n">widths_specified</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">])</span>
    <span class="n">amps_specified</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;cents_specified&#39;</span><span class="p">:</span><span class="n">cents_specified</span><span class="p">,</span>
            <span class="s1">&#39;types_specified&#39;</span><span class="p">:</span> <span class="n">types_specified</span><span class="p">,</span>
            <span class="s1">&#39;widths_specified&#39;</span><span class="p">:</span> <span class="n">widths_specified</span><span class="p">,</span>
            <span class="s1">&#39;amps_specified&#39;</span><span class="p">:</span> <span class="n">amps_specified</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>TODO move bounds making into a new function in main</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">arguments</span><span class="p">):</span>
    <span class="n">thunder</span> <span class="o">=</span> <span class="n">Thunder</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span> <span class="c1"># load object</span>

    <span class="n">thunder</span><span class="o">.</span><span class="n">background_finder</span><span class="p">()</span> <span class="c1"># then determine the background</span>
    <span class="n">thunder</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="n">thunder</span><span class="o">.</span><span class="n">y_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">thunder</span><span class="o">.</span><span class="n">normalisation</span><span class="p">(</span><span class="n">thunder</span><span class="o">.</span><span class="n">data_bg_rm</span><span class="p">[</span><span class="n">thunder</span><span class="o">.</span><span class="n">y_label</span><span class="p">])</span> <span class="c1"># normalise the data</span>

    <span class="n">specified_dict</span> <span class="o">=</span> <span class="n">peak_details</span><span class="p">(</span><span class="n">thunder</span><span class="o">.</span><span class="n">user_params</span><span class="p">)</span>
    <span class="n">thunder</span><span class="o">.</span><span class="n">peaks_unspecified</span><span class="p">(</span><span class="n">specified_dict</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>now fit peaks</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">thunder</span><span class="o">.</span><span class="n">fit_peaks</span><span class="p">()</span>
    <span class="n">thunder</span><span class="o">.</span><span class="n">plot_all</span><span class="p">()</span>
    <span class="n">thunder</span><span class="o">.</span><span class="n">fit_report</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">thunder</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <h3>tools</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_thunder</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;thunder.p&#39;</span><span class="p">):</span>
    <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">load_thunder</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">obj</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_plot</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="s1">&#39;figure.png&#39;</span><span class="p">):</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">figname</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_fit_report</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;report.json&quot;</span><span class="p">):</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>parse a params file which we assume is a dictionary
:param filepath: str: path to params file
:return: dictionary of paramters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_param_file</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;./params.txt&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>maybe use json loads if you end up writing parameter files non-manually</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>TODO: add some checks to user passed data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">arguments</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <h3>tools</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <h4>for saving and parsing</h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>convert argparse arguments into a dictionary for consistency later
:param arg: argparse parsed args
:return: dictionary of parameters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;x_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">x_label</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;y_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">y_label</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;e_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">y_label</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;x_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">x_ind</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;y_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">y_ind</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;e_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">e_ind</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">datapath</span>
        <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;user_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">user_params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>TODO: add some checks to user passed data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">arguments</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>function to make a directory, recursively adding _new if that name already exists
:param dirname: str: name of directory to create
:param i: the run number we are on
:return: str: the directory name which was available, and all subsequent data should be saved in</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{dirname}&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">FileExistsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">make_dir</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{dirname}_new&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;. So I named the file: {dirname}&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dirname</span>
        <span class="k">return</span> <span class="n">dirname</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <h4></h4>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>i.e. called from bash</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;fit peaks and background to the given data given a set of parameter&#39;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--param_file_path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./params.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;input filepath to param file, if you want to use it&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--x_label&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;x_axis&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the label for independent variables&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--y_label&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;y_axis&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the label for dependent variables&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--e_label&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;y_error&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the label for uncertainties in y&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--x_ind&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the column in data which is the independent data&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--y_ind&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the column in data which is the dependent data&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--e_ind&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the column in data which is the independent data uncertainties&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--datapath&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;./data.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;relative path to the datafile from where python script is called&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--user_params&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">Dict</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;yfit&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;peak_types&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;peak_centres&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;peak_widths&#39;</span><span class="p">:[],</span> <span class="s1">&#39;peak_amps&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;chisq&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;free_params&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                                          <span class="s1">&#39;p_value&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;tightness&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">},</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;the fit data as specified in the Thunder __init__&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>  <span class="c1"># this allows us to now use them all</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">param_file_path</span><span class="p">:</span> <span class="c1"># if there is a params file then use it</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using params file&#39;</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">parse_param_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">param_file_path</span><span class="p">)</span> <span class="c1"># parse it</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;not using params file&#39;</span><span class="p">)</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="c1"># else use argparse but put in dictionary form</span>

    <span class="n">dirname</span> <span class="o">=</span> <span class="n">make_dir</span><span class="p">(</span><span class="s1">&#39;analysed&#39;</span><span class="p">)</span>  <span class="c1"># make a dict for the processed data to be saved in</span>

    <span class="n">thunder</span> <span class="o">=</span> <span class="n">main</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>save a plot of the figure and the thunder object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">dataname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">])</span>
    <span class="n">save_plot</span><span class="p">(</span><span class="n">thunder</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;{dataname}.svg&quot;</span><span class="p">)</span>
    <span class="n">save_thunder</span><span class="p">(</span><span class="n">thunder</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;{dataname}.p&quot;</span><span class="p">)</span>
    <span class="n">save_fit_report</span><span class="p">(</span><span class="n">thunder</span><span class="o">.</span><span class="n">fit_data</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">f</span><span class="s2">&quot;{dataname}_report.json&quot;</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
