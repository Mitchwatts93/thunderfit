<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>utilities.py</title>
  <link rel="stylesheet" href="../../pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>utilities.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dump</span> <span class="k">as</span> <span class="n">j_dumps</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">j_load</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">mkdir</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strftime</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">dill</span> <span class="kn">import</span> <span class="n">dump</span> <span class="k">as</span> <span class="n">d_dump</span>
<span class="kn">from</span> <span class="nn">dill</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">d_load</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">vstack</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">frombuffer</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">normalisation</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>tools</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_thunder</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;thunder.d&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <pre><code>save a thunder object to a path using the dill package
:param obj:
:param path:
:param filename:
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;saving using dill {filename}&#39;</span><span class="p">)</span>
    <span class="n">d_dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <pre><code>load a dill dumped object
:param path:
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">load_thunder</span><span class="p">(</span><span class="n">path</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loading using dill&#39;</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">d_load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">obj</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <pre><code>save a plot as a svg
:param plot:
:param path:
:param figname:
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_plot</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">figname</span><span class="o">=</span><span class="s1">&#39;figure.svg&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;saving figure {figname}&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">figname</span><span class="p">),</span> <span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <pre><code>save a fit report dictionary as a json
:param obj:
:param path:
:param filename:
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">save_fit_report</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;report.json&quot;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;saving report {filename}&#39;</span><span class="p">)</span>
    <span class="n">j_dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <pre><code>given two lists returns list of indices indicating which indices in list 1 match each index in list 2. i.e. index 0
of the returned list indicates which index in list 1 matches index 0 in list 2
:param list1: a list of numbers
:param list2: a list of numbers
:return: a list of indices of matches
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">find_closest_indices</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="n">list_of_matching_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">list1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cent</span><span class="p">))</span>
                                    <span class="k">for</span> <span class="n">cent</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">]</span> <span class="c1">#  the lambda function is what min uses</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;this dataset has no values!&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">list_of_matching_indices</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <pre><code>given data with background removed, a background and the raw data, normalise the data with the bg removed and then
normalise the others according to this normalisation (i.e. use the mean and std from that)
:param y_bg_rem: np array of data after bg removed
:param bg: np array of bg
:param y_raw: np array of data before bg removed
:return: data np arrays normalised by svn normalisaiton
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">normalise_all</span><span class="p">(</span><span class="n">y_bg_rem</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;normalising many objects&#39;</span><span class="p">)</span>
    <span class="n">y_data_bg_rm</span><span class="p">,</span> <span class="p">(</span><span class="n">mean_y_data</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">normalisation</span><span class="o">.</span><span class="n">svn</span><span class="p">(</span><span class="n">y_bg_rem</span><span class="p">)</span>  <span class="c1"># normalise the data</span>
    <span class="n">background</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">normalisation</span><span class="o">.</span><span class="n">svn</span><span class="p">(</span><span class="n">bg</span><span class="p">,</span> <span class="n">mean_y_data</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">)</span>  <span class="c1"># normalise with data from bg subtracted data</span>
    <span class="n">y_data_norm</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">normalisation</span><span class="o">.</span><span class="n">svn</span><span class="p">(</span><span class="n">y_raw</span><span class="p">,</span> <span class="n">mean_y_data</span><span class="p">,</span> <span class="n">std_dev</span><span class="p">)</span>  <span class="c1"># normalise with data from bg subtracted data</span>

    <span class="k">return</span> <span class="n">y_data_bg_rm</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">y_data_norm</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>fetch items safely from a list, if it isn&rsquo;t long enough return a default value</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">safe_list_get</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">l</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <pre><code>a function to run a user guided routine to sharpen data using peak_sharpening function
:param x_data: np array of x data
:param y_data: np array of y data
:return: y_data sharpened by user chosen factors
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">sharpening_routine</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">sharpening_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">res_enhanced</span> <span class="o">=</span> <span class="n">y_data</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">res_enhanced</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Do you want to sharpen the peaks to help find components? Note this will not edit the actual data. &quot;</span>
              <span class="n">f</span><span class="s2">&quot;Current sharpening factor is: {sharpening_factor}&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please enter the method (either &#39;power&#39; or &#39;deriv&#39;), then a comma, then a new sharpening factors &quot;</span>
                    <span class="s2">&quot;(comma seperated if mutliple i.e. for derivative), &quot;</span>
                    <span class="s2">&quot;or type y to continue with the current factor&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">y_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">_type</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">sharpening_factor</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">fac</span><span class="p">)</span> <span class="k">for</span> <span class="n">fac</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">]</span>
                <span class="n">res_enhanced</span> <span class="o">=</span> <span class="n">peak_sharpening</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">sharpening_factor</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <pre><code>function to sharpen peaks. can use power or derivative methods
:param y_data: np array of y data
:param _type: the type of sharpening to be used
:param sharpening_factor: the factors to sharpen with
:return: the data sharpened
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">peak_sharpening</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">sharpening_factor</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;power&#39;</span><span class="p">:</span>
        <span class="n">res_enhanced</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">**</span> <span class="n">sharpening_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># raise to the power</span>
    <span class="k">elif</span> <span class="n">_type</span> <span class="o">==</span> <span class="s1">&#39;deriv&#39;</span><span class="p">:</span>
        <span class="n">y_double_prime</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">y_4_prime</span> <span class="o">=</span> <span class="n">pad</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">res_enhanced</span> <span class="o">=</span> <span class="n">y_data</span> <span class="o">-</span> <span class="n">sharpening_factor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_double_prime</span> <span class="o">+</span> <span class="n">sharpening_factor</span><span class="p">[</span>
            <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_4_prime</span>  <span class="c1"># this is the original data minus its</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>derivative multiplied by some factor</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;enter a correct type&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_enhanced</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>tools</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>user inputs and loading etc</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">x_ind</span><span class="p">,</span> <span class="n">y_ind</span><span class="p">,</span> <span class="n">e_ind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <pre><code>load in data as an np arra. can load from a csv or hs5 pandas
:param datapath: where to get data from
:param x_ind: which column to find x data
:param y_ind: which column to find y data
:param e_ind: optional, which column to find error data
:return: np arrays of the data loaded with nan values dropped across all values (note might break with error values)
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loading data&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;.h5&#39;</span> <span class="ow">in</span> <span class="n">datapath</span><span class="p">:</span>  <span class="c1"># if the data is already stored as a pandas df</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Too many keys in the hdfstore, will assume all should be concated&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;not sure this concat works yet&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">])</span>  <span class="c1"># not sure this will work! concat all keys dfs together</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">store</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># if only one key then we use it as the datafile</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># its a txt or csv file</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>  <span class="c1"># load in, works for .txt and .csv</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>  <span class="c1"># load in, works for .txt and .csv</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>this needs to be made more flexible/user defined</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">e_ind</span><span class="p">:</span>  <span class="c1"># if we have specified this column then we use it, otherwise just x and y</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;You have specified an e_ind but there are less than 3 columns in the data&quot;</span>
        <span class="n">e_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">e_ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e_data</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>  <span class="c1"># drop any rows with NaN etc in them</span>

    <span class="n">x_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x_ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">y_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">return</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">e_data</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <pre><code>function to get the unique coordinate values out from np arrays of data and coordinates
:param x_data:np array of x data
:param y_data: np array of y data
:param x_coords: np array of x coordinates, index corresponds to x and y data
:param y_coords: np array of y coordinates, index corresponds to x and y data
:return: lists of np arrays, each element matches, x_coords and y_coords contain lists of numbers only. so e.g.
index 0 of all has the x and y coordinates in coords lists at 0, and x and y data in those lists at 0 as np arrays
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">map_unique_coords</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing coordinates&#39;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">vstack</span><span class="p">((</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>  <span class="c1"># now have columns as the data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;x_data&#39;</span><span class="p">,</span> <span class="s1">&#39;y_data&#39;</span><span class="p">])</span>
    <span class="n">unique_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;x_coords&#39;</span><span class="p">,</span> <span class="s1">&#39;y_coords&#39;</span><span class="p">])))</span>  <span class="c1"># get a dictionary of the unique values for</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>coordinates (as tuples of (x,y)) and then the whole df rows for these values</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">unique_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">x_data_</span> <span class="o">=</span> <span class="n">unique_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;x_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># get the x_data</span>
        <span class="n">x_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_data_</span><span class="p">)</span>
        <span class="n">y_data_</span> <span class="o">=</span> <span class="n">unique_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;y_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_data_</span><span class="p">)</span>
        <span class="n">x_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <pre><code>parse a params file which we assume is a dictionary
:param filepath: str: path to params file
:return: dictionary of paramters
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_param_file</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;./params.txt&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>maybe use json loads if you end up writing parameter files non-manually</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing params file&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">arguments</span> <span class="o">=</span> <span class="n">j_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>TODO: add some checks to user passed data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">arguments</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <pre><code>convert argparse arguments into a dictionary for consistency later
:param arg: argparse parsed args
:return: dictionary of parameters
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing args&#39;</span><span class="p">)</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;x_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">x_ind</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;y_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">y_ind</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;e_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">e_ind</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;datapath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">datapath</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;no_peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">no_peaks</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;background&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">background</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;scarf_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">scarf_params</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;peak_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">peak_types</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;peak_centres&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">peak_centres</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;peak_widths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">peak_widths</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;peak_amps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">peak_amps</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;tightness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">tightness</span>
    <span class="n">arguments</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">bounds</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>TODO: add some checks to user passed data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">arguments</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <pre><code>function to make a directory, recursively adding _new if that name already exists
:param dirname: str: name of directory to create
:param i: the run number we are on
:return: str: the directory name which was available, and all subsequent data should be saved in
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;making dir&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mkdir</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{dirname}&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FileExistsError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">make_dir</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;{dirname}_new&#39;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;. So I named the file: {dirname}&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dirname</span>
    <span class="k">return</span> <span class="n">dirname</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <pre><code>given data either clip it or run a user guided routine to clip it
:param x_data: np array of x data
:param y_data: np array of y data
:param clips: either none or a list of two values which are left and right clips in terms of x values
:return: the indices of the clips to use
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">clip_data</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">clips</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;clipping data&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clips</span><span class="p">:</span>
        <span class="n">clip_left</span><span class="p">,</span> <span class="n">clip_right</span> <span class="o">=</span> <span class="n">clips</span>
        <span class="n">clip_left</span> <span class="o">=</span> <span class="n">find_closest_indices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="p">[</span><span class="n">clip_left</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">clip_right</span> <span class="o">=</span> <span class="n">find_closest_indices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="p">[</span><span class="n">clip_right</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clip_left</span><span class="p">,</span> <span class="n">clip_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">[</span><span class="n">clip_left</span><span class="p">:</span><span class="n">clip_right</span><span class="p">],</span> <span class="n">y_data</span><span class="p">[</span><span class="n">clip_left</span><span class="p">:</span><span class="n">clip_right</span><span class="p">])</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Removing background, please type two x values seperated by a space for the clips. </span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="n">f</span><span class="s2">&quot;Current values are: {x_data[clip_left]}, {x_data[clip_right]}. </span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="n">f</span><span class="s2">&quot;PLEASE MAKE SURE YOU ENTER IN THE SAME ORDER AS HERE. i.e. if first value is larger than right then the &quot;</span>
                  <span class="n">f</span><span class="s2">&quot;first value will be the large x_clip second small&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;If you are happy with the clips type y. If not then please type a new pair of values &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The tuple was more than two elements long&quot;</span><span class="p">)</span>
                    <span class="n">clip_left</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">clip_left</span> <span class="o">=</span> <span class="n">find_closest_indices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="p">[</span><span class="n">clip_left</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">clip_right</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">clip_right</span> <span class="o">=</span> <span class="n">find_closest_indices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="p">[</span><span class="n">clip_right</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">clip_left</span><span class="p">,</span> <span class="n">clip_right</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <pre><code>given some keywords and a function call the function
:param key_kwargs_: a tuple of (key, args) to use
:param func: function to call
:return: the key for this and the value returned from calling the func
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">apply_func</span><span class="p">(</span><span class="n">key_kwargs_</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">key</span> <span class="o">=</span> <span class="n">key_kwargs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kwargs_</span> <span class="o">=</span> <span class="n">key_kwargs_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">kwargs_</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <pre><code>function to setup a logger to save to file
:param log_name:
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">setup_logger</span><span class="p">(</span><span class="n">log_name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">curr_time</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">_%m_%Y_%l:%M%p&#39;</span><span class="p">)</span>
    <span class="n">log_filename</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{log_name}_{curr_time}.log&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_filename</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;have read in user arguments&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_filename</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <pre><code>function to make a gif of all the plots (with no uncertainty) and save it at filename
:param bag: a dictionary of the thunder objects which have been fit etc and are to be plotted
:param filename: where to save the gif
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">gif_maker</span><span class="p">(</span><span class="n">bag</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">bags</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">bag</span><span class="o">.</span><span class="n">values</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">thund</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">bags</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">thund</span><span class="o">.</span><span class="n">plot_all</span><span class="p">(</span><span class="n">plot_unc</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">f</span><span class="s1">&#39;PLOT_{i}&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">frombuffer</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">tostring_rgb</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_width_height</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span>

    <span class="kn">import</span> <span class="nn">imageio</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">mimsave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="p">[</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bag</span><span class="p">))],</span> <span class="n">fps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
