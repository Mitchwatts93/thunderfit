<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>scarf.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>scarf.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="nb">min</span><span class="p">,</span> <span class="n">float64</span>
<span class="kn">from</span> <span class="nn">pandas.core.frame</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">pandas.core.series</span> <span class="kn">import</span> <span class="n">Series</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;TkAgg&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <pre><code>Rolling circle filter (RCF) routine as described by James et al.: https://doi.org/10.1366%2F12-06766
:param A: np matrix of data
:param r: radius of circle to filter with
:return: L, a numpy array of length len(A) which is the locus of the RCF
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">rcf</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rad</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">Series</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># convert to numpy array</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Incorrect format passed for A&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span>
        <span class="n">rad</span><span class="p">)</span> <span class="o">==</span> <span class="n">rad</span><span class="p">,</span> <span class="s2">&quot;rad needs to be a positive integer&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;A needs to be a single column&quot;</span>

    <span class="n">RC</span> <span class="o">=</span> <span class="n">semi_circle_array</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">RC</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;something has gone wrong&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;The data has less points than the selected radius!&quot;</span><span class="p">)</span>

    <span class="n">A_sub</span><span class="p">,</span> <span class="n">RC_sub</span> <span class="o">=</span> <span class="n">generate_sub_matrices</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">generate_diff_matrix</span><span class="p">(</span><span class="n">A_sub</span><span class="p">,</span> <span class="n">RC_sub</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">D</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Generate an array of length 2r+1 with values corresponding to points on a semi circle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">semi_circle_array</span><span class="p">(</span><span class="n">rad</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">RC</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rad</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">rad</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">RC</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <pre><code>Generate the sub matrices used in RCF routine
:param A: Data matrix, length n
:param rad: radius of RCF filter
:param RC: np array of length 2r+1 with
:param n: integer describing length of A
:return: A_sub, RC_sub, lists of same dimensions, sampled according to paper: https://doi.org/10.1366%2F12-06766
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_sub_matrices</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">rad</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">ni</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">A_sub</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RC_sub</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)):</span>  <span class="c1"># vectorise this when you can be bothered</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">a_sub</span> <span class="o">=</span> <span class="n">A</span><span class="p">[:(</span><span class="n">i</span> <span class="o">+</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">rc_sub</span> <span class="o">=</span> <span class="n">RC</span><span class="p">[(</span><span class="n">rad</span> <span class="o">-</span> <span class="n">i</span><span class="p">):(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">A_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_sub</span><span class="p">)</span>
            <span class="n">RC_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc_sub</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">a_sub</span> <span class="o">=</span> <span class="n">A</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">rad</span><span class="p">):(</span><span class="n">i</span> <span class="o">+</span> <span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">rc_sub</span> <span class="o">=</span> <span class="n">RC</span>
            <span class="n">A_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_sub</span><span class="p">)</span>
            <span class="n">RC_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc_sub</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">rad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">a_sub</span> <span class="o">=</span> <span class="n">A</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="n">rad</span><span class="p">):(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">rc_sub</span> <span class="o">=</span> <span class="n">RC</span><span class="p">[:(</span><span class="n">rad</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">))]</span>
            <span class="n">A_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_sub</span><span class="p">)</span>
            <span class="n">RC_sub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc_sub</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;something has gone wrong&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something has gone wrong and I don&#39;t know why&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A_sub</span><span class="p">,</span> <span class="n">RC_sub</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <pre><code>Generate a difference matrix, which will be len(A_sub)=len(RC_sub). Each element will be the minimum of matrix
formed by the difference of AC_sub_i and RC_sub_i at each i (element).
:param A_sub: List of np arrays
:param RC_sub: List of np arrays
:return: D, Difference matrix of shape (len(A_sub),), elements as described above
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">generate_diff_matrix</span><span class="p">(</span><span class="n">A_sub</span><span class="p">,</span> <span class="n">RC_sub</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">D</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A_sub</span><span class="p">)):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">A_sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">RC_sub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">D</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>

    <span class="n">D</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">D</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <pre><code>Savgol filter applied to data
:param L: the data to be smoothed
:param window_length: positive odd integer
:param polyorder: must be less than window length
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">polyorder</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">polyorder</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mirror&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">user_guided_scarf</span><span class="p">(</span>
        <span class="n">x_data</span><span class="p">,</span>
        <span class="n">bg</span><span class="p">,</span>
        <span class="n">data_bg_rm_y</span><span class="p">,</span>
        <span class="n">params</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">rad</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
        <span class="n">window_length</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span>
        <span class="n">poly_order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">L_sg</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>rcf step</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">rcf</span><span class="p">(</span><span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">rad</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;SCARF background removal requires user input. Please look at the following bg with rad={rad}&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="s2">&quot;If you are happy with the plot, type y. if not then please type a new rad&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Please enter a smaller radius, the radius must be less than half the number of data points:&quot;</span>
                    <span class="n">f</span><span class="s2">&quot; {len(data_bg_rm_y)//2}&quot;</span><span class="p">)</span>
                <span class="n">rad</span> <span class="o">=</span> <span class="mi">70</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>then apply SG filter to D</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">L_sg</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">L_sg</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="n">f</span><span class="s2">&quot;Please look at the following bg with Sg filter parameters (window length, polynomial order): &quot;</span>
                    <span class="n">f</span><span class="s2">&quot;{window_length}, {poly_order}&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s2">&quot;Incorrect values for window_length and poly_order have been entered. Poly order must be less &quot;</span>
                    <span class="s2">&quot;than window length and window length must be odd&quot;</span><span class="p">)</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;please enter y if you are happy with these values, or enter two integers with a space &quot;</span>
                <span class="s2">&quot;for window_length and poly_order&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">L_sg</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="n">ans</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;The tuple was more than two elements long&quot;</span><span class="p">)</span>
                    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">poly_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;You entered an incorrect answer! Trying again...&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>get the bg shift up automatically
whats the smallest difference between D and b? shift it up by that</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">b</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_bg_rm_y</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">+</span> <span class="n">b</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>final question before exiting</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span> <span class="o">-</span> <span class="n">L</span><span class="p">,</span> <span class="s1">&#39;b--&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Please look at the following bg with selected parameters&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Are you happy with this bg? If yes, type y, else type n. n will restart the fitting. </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Typing repeat will add an additional bg subtraction to this one &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">+=</span> <span class="n">L</span>
            <span class="n">data_bg_rm_y</span> <span class="o">-=</span> <span class="n">L</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;rad&#39;</span><span class="p">:</span> <span class="n">rad</span><span class="p">,</span>
                           <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
                           <span class="s1">&#39;window_length&#39;</span><span class="p">:</span> <span class="n">window_length</span><span class="p">,</span>
                           <span class="s1">&#39;poly_order&#39;</span><span class="p">:</span> <span class="n">poly_order</span><span class="p">})</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">ans</span> <span class="o">==</span> <span class="s1">&#39;repeat&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">+=</span> <span class="n">L</span>
            <span class="n">data_bg_rm_y</span> <span class="o">-=</span> <span class="n">L</span>  <span class="c1"># remove the bg found here from the original data and go again</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s2">&quot;apply two bg removal steps, this will mean the background just specified will be removed &quot;</span>
                <span class="s2">&quot;from the data&quot;</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;rad&#39;</span><span class="p">:</span> <span class="n">rad</span><span class="p">,</span>
                           <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
                           <span class="s1">&#39;window_length&#39;</span><span class="p">:</span> <span class="n">window_length</span><span class="p">,</span>
                           <span class="s1">&#39;poly_order&#39;</span><span class="p">:</span> <span class="n">poly_order</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s2">&quot;You entered an incorrect answer! Trying whole fitting routine again...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">scarf_from_dict</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">scarf_params</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">rad</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">poly_order</span> <span class="o">=</span> \
        <span class="n">scarf_params</span><span class="p">[</span><span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">scarf_params</span><span class="p">[</span><span class="s1">&#39;window_length&#39;</span><span class="p">],</span> <span class="n">scarf_params</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">rcf</span><span class="p">(</span><span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">rad</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">window_length</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">scarf_params</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>  <span class="c1"># if passed then use it</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># otherwise find it</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>whats the smallest difference between D and b? shift it up by that</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">b</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_data</span> <span class="o">-</span> <span class="n">L</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">L</span> <span class="o">+</span> <span class="n">b</span>
    <span class="n">bg</span> <span class="o">+=</span> <span class="n">L</span>
    <span class="n">data_bg_rm_y</span> <span class="o">-=</span> <span class="n">L</span>
    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;rad&#39;</span><span class="p">:</span> <span class="n">rad</span><span class="p">,</span>
                   <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
                   <span class="s1">&#39;window_length&#39;</span><span class="p">:</span> <span class="n">window_length</span><span class="p">,</span>
                   <span class="s1">&#39;poly_order&#39;</span><span class="p">:</span> <span class="n">poly_order</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <pre><code>Routine to perform the scarf background subtraction. decides whether to run a user guided routine or anything else
depending on the input for scarf_params
:param x_data: the x data as an np array
:param y_data: the y data as an np array
:param scarf_params: can be one of bool, dict or list of dicts.
:return:
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">perform_scarf</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">scarf_params</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;performing scarf bg subtraction&#39;</span><span class="p">)</span>

    <span class="n">bg</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">y_data</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">float64</span><span class="p">)</span>  <span class="c1"># initialise</span>
    <span class="n">data_bg_rm_y</span> <span class="o">=</span> <span class="n">y_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scarf_params</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scarf_params</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;setting scarf parameters via user guided method&#39;</span><span class="p">)</span>
        <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">user_guided_scarf</span><span class="p">(</span><span class="n">x_data</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scarf_params</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>the user has passed True! recall this function and change it to false</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;scarf has been passed the True bool value for scarf params. This is invalid, assuming you meant &#39;</span>
            <span class="s1">&#39;False as no parameters were specified.&#39;</span><span class="p">)</span>
        <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params_</span> <span class="o">=</span> <span class="n">perform_scarf</span><span class="p">(</span>
            <span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">scarf_params</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="n">params_</span>  <span class="c1"># params_ is a list of one dictionary</span>
        <span class="k">return</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scarf_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;using scarf params: {scarf_params}&#39;</span><span class="p">)</span>
        <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">scarf_from_dict</span><span class="p">(</span>
            <span class="n">y_data</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">scarf_params</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scarf_params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;using scarf params: {scarf_params}&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>the user wants multiple runs. call the function for each set of
params, passing the new y data each time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">param_dict</span> <span class="ow">in</span> <span class="n">scarf_params</span><span class="p">:</span>
            <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg_</span><span class="p">,</span> <span class="n">params_</span> <span class="o">=</span> <span class="n">perform_scarf</span><span class="p">(</span>
                <span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">scarf_params</span><span class="o">=</span><span class="n">param_dict</span><span class="p">)</span>
            <span class="n">bg</span> <span class="o">+=</span> <span class="n">bg_</span>
            <span class="n">params</span> <span class="o">+=</span> <span class="n">params_</span>  <span class="c1"># params_ is a list of a dictionary so use += here</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;an unexpected parameter has been passed as a scarf value, running interactively.&#39;</span><span class="p">)</span>
        <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params_</span> <span class="o">=</span> <span class="n">perform_scarf</span><span class="p">(</span>
            <span class="n">x_data</span><span class="p">,</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">scarf_params</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">+=</span> <span class="n">params_</span>
        <span class="k">return</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;scarf bg parameters are: {params}&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data_bg_rm_y</span><span class="p">,</span> <span class="n">bg</span><span class="p">,</span> <span class="n">params</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
